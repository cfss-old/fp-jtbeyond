---
title: "Source and Methods"
output:
  html_document:
    theme: cosmo
---

```{r setup, include = FALSE}
library(tidyverse)
library(feather)
library (knitr)
library(tidytext)
library(DT)

df<-read_feather("data/df")

top_1986<-read_feather("data/model1986_top6") %>%
  select (word, En, estimate, std.error, p.value)
names(top_1986)<- c("Chinese word", "Engish translation", "predicted frequency","standard error", "p-value")

top_1989<-read_feather("data/model1989_top6") %>%
  select (word, En, estimate, std.error, p.value) 
names(top_1989)<- c("Chinese word", "Engish translation", "predicted frequency","standard error", "p-value")
```




# Datasource:
```{r DTtable, echo = FALSE}

data.table<-read_feather("data/df") %>%
  select(Datetime, term, count) %>%
  filter (count > 10) %>%
  filter(Datetime >= as.Date("1989-04-04") & Datetime <= as.Date("1989-07-07"))
  

datatable (data.table)

```





In this section, we explore the data through building the model for the word frequency before and after the student movement in 1986 and 1989 respectively. 

```{r fig.width=4, fig.height=4,echo=FALSE,out.extra='style="fixed:left"'}
df1989<- df %>%
  filter(Datetime >= as.Date("1989-06-04") & Datetime <= as.Date("1990-06-04")) %>%
  separate (year_month, c("Year", "Month"), sep="-") %>%
  # since "term" will be interfered with the "term" generated by the models
  mutate (word = term)
  

data1989<-df1989 %>%
  count (Datetime, word) %>%
  ungroup() %>%
  group_by (Datetime) %>%
  mutate (day_total = sum(n),
          percent = n / day_total) %>%
  ungroup()



model1989<- data1989 %>%
  group_by(word) %>%
  filter(sum(n) > 50) %>%
  do(tidy(glm(cbind(n, day_total - n) ~ Datetime, .,
              family = "binomial"))) %>%
  ungroup() %>%
  filter (term == "Datetime") %>%
  arrange (desc(abs(estimate))) %>%
  filter (p.value <= 0.005)  



# plot the word change before and after the end of the social movement:

model1989 %>%
  mutate(adjusted.p.value = p.adjust(p.value)) %>%
  ggplot(aes(estimate, adjusted.p.value)) +
  theme_bw() + 
  geom_point() +
  scale_y_log10() +
  xlab("Estimated change over time") +
  ylab("Adjusted p-value") +
  labs(title="June 1989 - June 1990")


```
```{r fig.width=4, fig.height=4,echo=FALSE, out.extra='style="fixed:right"'}
df1986<- df %>%
  filter(Datetime >= as.Date("1986-12-27") & Datetime <= as.Date("1987-12-27")) %>%
  separate (year_month, c("Year", "Month"), sep="-") %>%
  # since "term" will be interfered with the "term" generated by the models
  mutate (word = term)
  
data1986<-df1986 %>%
  count (Datetime, word) %>%
  ungroup() %>%
  group_by (Datetime) %>%
  mutate (day_total = sum(n),
          percent = n / day_total) %>%
  ungroup()



model1986<- data1986 %>%
  group_by(word) %>%
  filter(sum(n) > 50) %>%
  do(tidy(glm(cbind(n, day_total - n) ~ Datetime, .,
              family = "binomial"))) %>%
  ungroup() %>%
  filter (term == "Datetime") %>%
  arrange (desc(abs(estimate))) %>%
  filter (p.value <= 0.005) 

# plot the word change before and after the end of the social movement:

model1986 %>%
  mutate(adjusted.p.value = p.adjust(p.value)) %>%
  ggplot(aes(estimate, adjusted.p.value)) +
  theme_bw() + 
  geom_point() +
  scale_y_log10() +
  xlab("Estimated change over time") +
  ylab("Adjusted p-value") +
  labs(title="December 1986 - December 1987")
```






Table for the statistic data of the words with high frequeny change after 1986`s social movement (only the top 6 has been shown here)
```{r Table-1, echo=FALSE}
kable(top_1986, digits=5, align ="c")

```


Table for the statistic data of the words with high frequeny change during 1989`s social movement (only the top 6 has been shown here)
```{r Table-2, echo=FALSE}
kable(top_1989, digits=5, align ="c")

```

Plots of the counts of the words, of which the frequency change dramatically after the social movement in 1986

```{r fig.width=4, fig.height=4,echo=FALSE,out.extra='style="fixed:left"'}
df<-read_feather("data/df") %>%
  select(Datetime, term, count) %>%
  group_by (Datetime, term) %>%
  summarise (count=sum(count)) %>%
  ungroup()

wordlist3=c("资产阶级自由化", "安定团结")

df %>%
  filter(Datetime >= as.Date("1986-10-01") & Datetime <= as.Date("1987-12-01")) %>%
  filter (term %in% wordlist3) %>%
  mutate (en_term=ifelse(term=="资产阶级自由化", "bourgeois liberalism", "stability and unity")) %>%
  complete(Datetime, en_term, fill =list (count=0)) %>%
  ggplot(aes(x=Datetime, y=count, color=en_term)) +
  theme_bw()+
  geom_line()+
  labs(title="1986 -1987", 
       subtitle="Bourgeois Liberalism vs. Stability and Unity",
       x="date", y="Count")+
  theme(legend.title=element_blank(), legend.position="bottom") 

 
```
```{r fig.width=4, fig.height=4,echo=FALSE, out.extra='style="fixed:right"'}
wordlist4 = c("建设", "四项")

df %>%
  filter(Datetime >= as.Date("1986-12-01") & Datetime <= as.Date("1987-12-01")) %>%
  filter (term %in% wordlist4) %>%
  mutate (en_term=ifelse(term=="建设", "Economic Construction", "Four Principles")) %>%
  complete(Datetime, en_term, fill =list (count=0)) %>%
  ggplot(aes(x=Datetime, y=count, color=en_term)) +
  theme_bw()+
  geom_line()+
  labs(title="1986 -1987", 
       subtitle="Economic Construction and Four Principles",
       x="date", y="Count")+
  theme(legend.title=element_blank(), legend.position="bottom") 
```


Plots of the counts of the words, of which the frequency change dramatically after the social movement in 1989

```{r fig.width=4, fig.height=4,echo=FALSE,out.extra='style="fixed:left"'}
wordlist1=c("动乱", "暴乱")

df %>%
  filter(Datetime >= as.Date("1989-04-01") & Datetime <= as.Date("1990-06-04")) %>%
  filter (term %in% wordlist1)%>%
  mutate (en_term=ifelse(term=="动乱", "Unrest", "Riots")) %>%
  complete(Datetime, en_term, fill =list (count=0)) %>%
  ggplot(aes(x=Datetime, y=count, color=en_term)) +
  theme_bw()+
  geom_line()+
  labs(title="1989 -1990", 
       subtitle="Unrest vs. Riots",
       x="date", y="count (per day)")+
  theme(legend.title=element_blank(), legend.position="bottom")

```
```{r fig.width=4, fig.height=4,echo=FALSE, out.extra='style="fixed:right"'}
wordlist2=c("反革命", "稳定")

df %>%
  filter(Datetime >= as.Date("1989-05-01") & Datetime <= as.Date("1990-06-04")) %>%
  filter (term %in% wordlist2)%>%
  mutate (en_term=ifelse(term=="稳定", "Stability", "the Counter-revolution")) %>%
  complete(Datetime, en_term, fill =list (count=0)) %>%
  ggplot(aes(x=Datetime, y=count, color=en_term)) +
  theme_bw()+
  geom_line()+
  labs(title="1989 -1990", 
       subtitle="the Counter-revolution vs. Stability",
       x="date", y="count (per day)")+
  theme(legend.title=element_blank(), legend.position="bottom")


```




```{r shiny-app, echo = FALSE}




```